name: CD

on:
  workflow_run:
    workflows: ["CI"]
    types: [completed]
    branches: [main, master]

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    
    steps:
      - name: Deploy to VPS
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT || 22 }}
          command_timeout: 30m
          script: |
            set -e
            cd ~/platform_help_teacher
            
            # Detect what changed
            git fetch origin master
            CHANGED_FILES=$(git diff --name-only HEAD origin/master)
            echo "Changed files: $CHANGED_FILES"
            
            git reset --hard origin/master
            cd deploy
            
            if [ ! -f ".env" ]; then
              echo "ERROR: .env not found!"
              exit 1
            fi
            
            # Determine what needs rebuild
            REBUILD_BACKEND=false
            REBUILD_FRONTEND=false
            NGINX_ONLY=false
            
            if echo "$CHANGED_FILES" | grep -qE "^backend/"; then
              REBUILD_BACKEND=true
            fi
            if echo "$CHANGED_FILES" | grep -qE "^frontend/"; then
              REBUILD_FRONTEND=true
            fi
            
            # Check if only nginx/deploy configs changed
            if [ "$REBUILD_BACKEND" = "false" ] && [ "$REBUILD_FRONTEND" = "false" ]; then
              if echo "$CHANGED_FILES" | grep -qE "^deploy/nginx"; then
                NGINX_ONLY=true
              fi
            fi
            
            # NGINX-only: hot reload without restart
            if [ "$NGINX_ONLY" = "true" ]; then
              echo "=== Nginx config changed, hot reload ==="
              docker cp nginx.conf edu-proxy-prod:/etc/nginx/nginx.conf
              docker exec edu-proxy-prod nginx -t && docker exec edu-proxy-prod nginx -s reload
              echo "=== Nginx reloaded ==="
            # No code changes: just restart
            elif [ "$REBUILD_BACKEND" = "false" ] && [ "$REBUILD_FRONTEND" = "false" ]; then
              echo "=== No code changes, restarting containers ==="
              docker compose -f docker-compose.prod.yml restart
              sleep 10
            # Code changed: rebuild
            else
              echo "=== Code changed, rebuilding ==="
              
              # Build only changed services (with cache)
              if [ "$REBUILD_BACKEND" = "true" ]; then
                echo "Rebuilding backend..."
                docker compose -f docker-compose.prod.yml build backend celery
              fi
              if [ "$REBUILD_FRONTEND" = "true" ]; then
                echo "Rebuilding frontend..."
                docker compose -f docker-compose.prod.yml build frontend
              fi
              
              # Restart with new images
              docker compose -f docker-compose.prod.yml up -d
              sleep 20
              
              # Reload nginx to refresh DNS cache (backend IP may have changed)
              echo "=== Reloading nginx DNS cache ==="
              docker cp nginx.conf edu-proxy-prod:/etc/nginx/nginx.conf
              docker exec edu-proxy-prod nginx -s reload
            fi
            
            # Run migrations if backend changed
            if [ "$REBUILD_BACKEND" = "true" ]; then
              echo "=== Running migrations ==="
              docker exec edu-backend-prod alembic upgrade head || echo "Migration warning"
            fi
            
            echo "=== Status ==="
            docker compose -f docker-compose.prod.yml ps
            echo "=== Deploy complete ==="
